<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYT Dashboard - Chasing Your Tail NG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h1::before {
            content: "üéØ";
        }

        .kismet-link {
            padding: 6px 12px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid #6366f1;
            border-radius: 8px;
            color: #a5b4fc;
            text-decoration: none;
            font-size: 12px;
            transition: all 0.2s;
        }

        .kismet-link:hover {
            background: rgba(99, 102, 241, 0.3);
            color: #fff;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-online {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .status-offline {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 48px;
            font-weight: 700;
            color: #fff;
            line-height: 1;
        }

        .card-subtitle {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }

        /* Alert Level Card */
        .alert-card {
            grid-column: span 2;
        }

        .alert-level {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .alert-indicator {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            animation: pulse 2s infinite;
        }

        .alert-GREEN {
            background: radial-gradient(circle, rgba(34, 197, 94, 0.3) 0%, rgba(34, 197, 94, 0.1) 70%);
            box-shadow: 0 0 40px rgba(34, 197, 94, 0.3);
        }

        .alert-YELLOW {
            background: radial-gradient(circle, rgba(234, 179, 8, 0.3) 0%, rgba(234, 179, 8, 0.1) 70%);
            box-shadow: 0 0 40px rgba(234, 179, 8, 0.3);
        }

        .alert-RED {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.3) 0%, rgba(239, 68, 68, 0.1) 70%);
            box-shadow: 0 0 40px rgba(239, 68, 68, 0.3);
            animation: pulse-red 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
        }

        @keyframes pulse-red {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .alert-details {
            flex: 1;
        }

        .alert-details h2 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .alert-details p {
            color: #888;
            font-size: 16px;
        }

        .text-green { color: #22c55e; }
        .text-yellow { color: #eab308; }
        .text-red { color: #ef4444; }
        .text-blue { color: #3b82f6; }
        .text-purple { color: #a855f7; }

        /* Device List */
        .device-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .device-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .device-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .device-mac {
            color: #fff;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .device-vendor {
            color: #888;
            font-size: 11px;
        }

        .device-vendor.randomized {
            color: #a855f7;
            font-style: italic;
        }

        .device-category {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .cat-network { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .cat-mobile { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .cat-iot { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .cat-media { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .cat-unknown { background: rgba(107, 114, 128, 0.2); color: #6b7280; }

        .device-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
        }

        .type-drone {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .type-close {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .type-stalker {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            font-weight: 600;
        }

        .type-watched {
            background: rgba(249, 115, 22, 0.2);
            color: #f97316;
            font-weight: 500;
        }

        .type-attacker {
            background: rgba(239, 68, 68, 0.4);
            color: #ef4444;
            font-weight: 700;
            animation: pulse-red 1.5s infinite;
        }

        /* Threat Activity Panel */
        .threat-panel {
            grid-column: span 2;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .threat-panel.active-threat {
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }

        .threat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .threat-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .threat-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .threat-indicator.clear {
            background: #22c55e;
        }

        .threat-indicator.recent {
            background: #eab308;
        }

        .threat-indicator.active {
            background: #ef4444;
            animation: pulse-red 1s infinite;
        }

        .threat-status-text {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .threat-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .threat-sections {
                grid-template-columns: 1fr;
            }
        }

        .threat-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 16px;
        }

        .threat-section-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .threat-count-badge {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .threat-count-badge.warning {
            background: rgba(234, 179, 8, 0.3);
            color: #eab308;
        }

        .threat-count-badge.clear {
            background: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .attack-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .attack-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 12px;
            border-left: 3px solid transparent;
        }

        .attack-item.critical {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .attack-item.high {
            border-left-color: #f97316;
            background: rgba(249, 115, 22, 0.1);
        }

        .attack-item.medium {
            border-left-color: #eab308;
        }

        .attack-item.low {
            border-left-color: #6b7280;
        }

        .attack-info {
            flex: 1;
        }

        .attack-type {
            font-weight: 600;
            color: #fff;
        }

        .attack-target {
            font-family: 'SF Mono', Monaco, monospace;
            color: #888;
            font-size: 11px;
            margin-top: 2px;
        }

        .attack-time {
            color: #666;
            font-size: 11px;
            white-space: nowrap;
        }

        .threat-actor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #ef4444;
        }

        .threat-actor-info {
            flex: 1;
        }

        .threat-actor-mac {
            font-family: 'SF Mono', Monaco, monospace;
            color: #ef4444;
            font-weight: 600;
            font-size: 12px;
        }

        .threat-actor-reason {
            color: #888;
            font-size: 11px;
            margin-top: 2px;
        }

        .threat-actor-vendor {
            color: #666;
            font-size: 10px;
        }

        .no-threats {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 13px;
        }

        .no-threats-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* Manufacturer Summary */
        .vendor-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .vendor-chip {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .vendor-chip .count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }

        /* Stats Row */
        .stats-row {
            display: flex;
            gap: 30px;
            margin-top: 16px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* Footer */
        footer {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #333;
            color: #555;
            font-size: 13px;
        }

        .last-update {
            margin-top: 8px;
            font-size: 12px;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error State */
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 768px) {
            .alert-card {
                grid-column: span 1;
            }

            .alert-level {
                flex-direction: column;
                text-align: center;
            }

            .card-value {
                font-size: 36px;
            }

            .device-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>Chasing Your Tail NG</h1>
                <a href="http://10.211.55.10:2501" target="_blank" class="kismet-link">Open Kismet UI</a>
            </div>
            <span id="connection-status" class="status-badge status-offline">Connecting...</span>
        </header>

        <div id="dashboard-content">
            <div class="loading">
                <div class="spinner"></div>
                <span>Connecting to CYT API...</span>
            </div>
        </div>

        <footer>
            <div>Chasing Your Tail NG v2.3 - Wireless Surveillance Detection System</div>
            <div class="last-update">Last updated: <span id="last-update">--</span></div>
        </footer>
    </div>

    <script>
        // Use proxy for all API calls - handles both VM forwarding and local endpoints (attacks, watchlist)
        const API_URL = 'http://localhost:8080/api';
        const API_KEY = '4irSMYe38Y-5ONUPhcsPr5MtFx2ViKrkTvhea3YuN9Y';
        const REFRESH_INTERVAL = 10000; // 10 seconds

        // OUI Database - Common manufacturers (first 6 hex chars without colons)
        const OUI_DATABASE = {
            // Apple
            '000A27': 'Apple', '000A95': 'Apple', '000D93': 'Apple', '001451': 'Apple',
            '0016CB': 'Apple', '0017F2': 'Apple', '0019E3': 'Apple', '001B63': 'Apple',
            '001CB3': 'Apple', '001D4F': 'Apple', '001E52': 'Apple', '001EC2': 'Apple',
            '001F5B': 'Apple', '001FF3': 'Apple', '002241': 'Apple', '002312': 'Apple',
            '002332': 'Apple', '00236C': 'Apple', '002500': 'Apple', '00264A': 'Apple',
            '002608': 'Apple', '003065': 'Apple', '003EE1': 'Apple', '0050E4': 'Apple',
            '20A2E4': 'Apple', '24A074': 'Apple', '28E02C': 'Apple', '3C15C2': 'Apple',
            '9C3E53': 'Apple', 'A4D1D2': 'Apple', 'ACBC32': 'Apple', 'B8E856': 'Apple',

            // Samsung
            '002119': 'Samsung', '002339': 'Samsung', '002566': 'Samsung', '1C62B8': 'Samsung',
            '2C4401': 'Samsung', '5056BF': 'Samsung', '5C0A5B': 'Samsung', '78BD6E': 'Samsung',
            '84119E': 'Samsung', '8C71F8': 'Samsung', '94350A': 'Samsung', '9463D1': 'Samsung',
            'A0B4A5': 'Samsung', 'B0EC71': 'Samsung', 'C45006': 'Samsung', 'E09D13': 'Samsung',

            // Google/Nest
            '1C7B21': 'Google', '3C5AB4': 'Google', '54609A': 'Google', '94EB2C': 'Google',
            'D86C63': 'Google', 'F4F5DB': 'Google', 'B423A2': 'Google',

            // Amazon/Ring/Eero
            '00FC8B': 'Amazon', '0C47C9': 'Amazon', '38F73D': 'Amazon', '44650D': 'Amazon',
            '68DB96': 'Amazon', '74C246': 'Amazon', 'A002DC': 'Amazon', 'B47C9C': 'Amazon',
            'F0D2F1': 'Amazon', 'D016C7': 'eero', 'B42046': 'eero',

            // Network Equipment
            '001A2B': 'Cisco', '001B2F': 'Netgear', '001E58': 'D-Link', '001F33': 'Netgear',
            'B09575': 'TP-Link', 'C04A00': 'TP-Link', 'E894F6': 'TP-Link', '18A5FF': 'Arcadyan',
            '186041': 'Arcadyan', '4405A3': 'Sagemcom', '44053F': 'Sagemcom',

            // Streaming/Media
            '105932': 'Roku', 'B0A737': 'Roku', 'D83134': 'Roku', 'AC3A7A': 'Roku',
            '5CAAFD': 'Sonos', '48A6B8': 'Sonos', '000E58': 'Sonos',
            '788038': 'FUNAI/TV', 'B88687': 'Liteon',

            // IoT/Smart Home
            'ACD074': 'Espressif', '240AC4': 'Espressif', '24B2DE': 'Espressif',
            '5C25C1': 'Ring', '0C8CCC': 'Chamberlain',

            // Cable/ISP Equipment
            'C44FD5': 'Vantiva', '6C55E8': 'Vantiva', '8C2DAA': 'Vantiva', '889E68': 'Vantiva',
            '4075C3': 'Vantiva', '54A65C': 'Vantiva', 'E4BFFA': 'Vantiva', '08A7C0': 'Vantiva',
            '48E2AD': 'HUMAX', 'A840F8': 'HUMAX', '20F19E': 'Commscope', 'D4ABCD': 'Gaoshengda',

            // Laptops/PCs
            '001A7D': 'Dell', '0021F6': 'HP', '0024E8': 'Lenovo', '001D60': 'ASUS',
            '581122': 'ASUS', '002564': 'Dell', '001E4F': 'Dell',

            // Drones
            '606001F': 'DJI', '34D262': 'DJI', '9003B7': 'Parrot', '001C27': 'Parrot',
            '60601F': 'DJI'
        };

        // Category mapping
        const VENDOR_CATEGORIES = {
            'Apple': 'mobile', 'Samsung': 'mobile', 'Google': 'iot', 'Amazon': 'iot',
            'eero': 'network', 'Cisco': 'network', 'Netgear': 'network', 'D-Link': 'network',
            'TP-Link': 'network', 'Arcadyan': 'network', 'Sagemcom': 'network',
            'Roku': 'media', 'Sonos': 'media', 'FUNAI/TV': 'media', 'Liteon': 'media',
            'Espressif': 'iot', 'Ring': 'iot', 'Chamberlain': 'iot',
            'Vantiva': 'network', 'HUMAX': 'network', 'Commscope': 'network', 'Gaoshengda': 'iot',
            'Dell': 'mobile', 'HP': 'mobile', 'Lenovo': 'mobile', 'ASUS': 'mobile',
            'DJI': 'drone', 'Parrot': 'drone'
        };

        function isRandomizedMac(mac) {
            // Check if local bit is set (second hex char is 2, 6, A, or E)
            const firstByte = parseInt(mac.replace(/:/g, '').substring(0, 2), 16);
            return (firstByte & 0x02) !== 0;
        }

        function lookupVendor(mac) {
            if (isRandomizedMac(mac)) {
                return { vendor: 'Randomized MAC', category: 'unknown', isRandomized: true };
            }

            const oui = mac.replace(/:/g, '').substring(0, 6).toUpperCase();
            const vendor = OUI_DATABASE[oui] || 'Unknown';
            const category = VENDOR_CATEGORIES[vendor] || 'unknown';

            return { vendor, category, isRandomized: false };
        }

        function getCategoryClass(category) {
            const classes = {
                'network': 'cat-network',
                'mobile': 'cat-mobile',
                'iot': 'cat-iot',
                'media': 'cat-media',
                'drone': 'type-drone',
                'unknown': 'cat-unknown'
            };
            return classes[category] || 'cat-unknown';
        }

        function getCategoryLabel(category) {
            const labels = {
                'network': 'Network',
                'mobile': 'Mobile',
                'iot': 'IoT',
                'media': 'Media',
                'drone': 'Drone',
                'unknown': '?'
            };
            return labels[category] || '?';
        }

        async function fetchStatus() {
            try {
                const response = await fetch(`${API_URL}/status`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch status:', error);
                throw error;
            }
        }

        async function fetchTargets() {
            try {
                const response = await fetch(`${API_URL}/targets`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch targets:', error);
                return { stalker_count: 0, stalker_macs: [] };
            }
        }

        async function fetchWatchlist() {
            try {
                const response = await fetch(`${API_URL}/watchlist`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch watchlist:', error);
                return { watched_macs: [], attacker_macs: [] };
            }
        }

        async function fetchAttacks() {
            try {
                const response = await fetch(`${API_URL}/attacks`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Failed to fetch attacks:', error);
                return {
                    threat_status: 'UNKNOWN',
                    active_attacks: [],
                    recent_attacks: [],
                    threat_actors: []
                };
            }
        }

        function getAlertIcon(level) {
            switch (level) {
                case 'GREEN': return '‚úì';
                case 'YELLOW': return '‚ö†';
                case 'RED': return '‚ö†';
                default: return '?';
            }
        }

        function getAlertMessage(level, drones, traffic) {
            if (level === 'RED') {
                return `ALERT: ${drones} drone(s) detected in your vicinity!`;
            } else if (level === 'YELLOW') {
                return `Elevated activity: ${traffic} devices detected in the last 5 minutes.`;
            } else {
                return 'All clear. No threats detected.';
            }
        }

        function getVendorSummary(devices) {
            const vendorCounts = {};
            devices.forEach(d => {
                const { vendor } = lookupVendor(d.id);
                vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            });

            return Object.entries(vendorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8)
                .map(([vendor, count]) => `
                    <div class="vendor-chip">
                        <span>${vendor}</span>
                        <span class="count">${count}</span>
                    </div>
                `).join('');
        }

        function renderThreatPanel(attacks) {
            const status = attacks.threat_status || 'CLEAR';
            const activeCount = attacks.active_count || 0;
            const recentCount = attacks.recent_count || 0;
            const threatActors = attacks.threat_actors || [];

            let indicatorClass = 'clear';
            let statusText = 'ALL CLEAR';
            let statusColor = 'text-green';

            if (status.includes('ACTIVE')) {
                indicatorClass = 'active';
                statusText = status.includes('CRITICAL') ? 'ACTIVE ATTACK!' : 'ACTIVE ATTACK';
                statusColor = 'text-red';
            } else if (status.includes('RECENT')) {
                indicatorClass = 'recent';
                statusText = 'RECENT ACTIVITY';
                statusColor = 'text-yellow';
            }

            const isActiveThreat = status.includes('ACTIVE');

            return `
                <div class="card threat-panel ${isActiveThreat ? 'active-threat' : ''}">
                    <div class="threat-header">
                        <span class="card-title">‚ö†Ô∏è Threat Activity Monitor</span>
                        <div class="threat-status">
                            <div class="threat-indicator ${indicatorClass}"></div>
                            <span class="threat-status-text ${statusColor}">${statusText}</span>
                        </div>
                    </div>

                    <div class="threat-sections">
                        <!-- Active/Recent Attacks Section -->
                        <div class="threat-section">
                            <div class="threat-section-title">
                                Recent Attacks
                                <span class="threat-count-badge ${activeCount > 0 ? '' : recentCount > 0 ? 'warning' : 'clear'}">
                                    ${activeCount > 0 ? `${activeCount} ACTIVE` : recentCount > 0 ? `${recentCount} recent` : 'None'}
                                </span>
                            </div>
                            <div class="attack-list">
                                ${renderAttackList(attacks.active_attacks || [], attacks.recent_attacks || [])}
                            </div>
                        </div>

                        <!-- Known Threat Actors Section -->
                        <div class="threat-section">
                            <div class="threat-section-title">
                                Known Threat Actors
                                <span class="threat-count-badge ${threatActors.length > 0 ? '' : 'clear'}">
                                    ${threatActors.length || 'None'}
                                </span>
                            </div>
                            <div class="attack-list">
                                ${renderThreatActors(threatActors)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAttackList(activeAttacks, recentAttacks) {
            const allAttacks = [...activeAttacks, ...recentAttacks].slice(0, 10);

            if (allAttacks.length === 0) {
                return `
                    <div class="no-threats">
                        <div class="no-threats-icon">‚úì</div>
                        No attacks detected in the last hour
                    </div>
                `;
            }

            return allAttacks.map((attack, index) => {
                const isActive = index < activeAttacks.length;
                return `
                    <div class="attack-item ${attack.severity} ${isActive ? 'active' : ''}">
                        <div class="attack-info">
                            <div class="attack-type">${attack.type}${isActive ? ' üî¥' : ''}</div>
                            <div class="attack-target">${attack.mac} ${attack.vendor ? `(${attack.vendor})` : ''}</div>
                        </div>
                        <div class="attack-time">${attack.time_ago || attack.time_str}</div>
                    </div>
                `;
            }).join('');
        }

        function renderThreatActors(actors) {
            if (actors.length === 0) {
                return `
                    <div class="no-threats">
                        <div class="no-threats-icon">üëÅÔ∏è</div>
                        No known threat actors on watchlist
                    </div>
                `;
            }

            return actors.map(actor => `
                <div class="threat-actor-item">
                    <div class="threat-actor-info">
                        <div class="threat-actor-mac">${actor.mac}</div>
                        <div class="threat-actor-reason">${actor.reason || actor.ssid}</div>
                        ${actor.vendor ? `<div class="threat-actor-vendor">${actor.vendor}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderDashboard(status, targets, watchlist = {}, attacks = {}) {
            const content = document.getElementById('dashboard-content');
            const connectionStatus = document.getElementById('connection-status');
            const lastUpdate = document.getElementById('last-update');

            connectionStatus.textContent = 'Online';
            connectionStatus.className = 'status-badge status-online';
            lastUpdate.textContent = new Date().toLocaleTimeString();

            const alertLevel = status.alert_level || 'GREEN';
            const alertColorClass = `text-${alertLevel.toLowerCase()}`;
            const pins = status.map_pins || [];

            content.innerHTML = `
                <div class="grid">
                    <!-- Threat Activity Panel -->
                    ${renderThreatPanel(attacks)}

                    <!-- Alert Level Card -->
                    <div class="card alert-card">
                        <div class="card-header">
                            <span class="card-title">Threat Level</span>
                        </div>
                        <div class="alert-level">
                            <div class="alert-indicator alert-${alertLevel}">
                                ${getAlertIcon(alertLevel)}
                            </div>
                            <div class="alert-details">
                                <h2 class="${alertColorClass}">${alertLevel}</h2>
                                <p>${getAlertMessage(alertLevel, status.drones_detected, status.traffic_5m)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Drones Card -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Drones Detected</span>
                            <span>üõ∏</span>
                        </div>
                        <div class="card-value ${status.drones_detected > 0 ? 'text-red' : ''}">${status.drones_detected}</div>
                        <div class="card-subtitle">Known drone OUI patterns</div>
                    </div>

                    <!-- Stalkers Card -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Persistent Followers</span>
                            <span>üëÅ</span>
                        </div>
                        <div class="card-value ${targets.stalker_count > 0 ? 'text-yellow' : ''}">${targets.stalker_count}</div>
                        <div class="card-subtitle">Devices seen 20min ago AND now</div>
                    </div>

                    <!-- Traffic Stats Card -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Network Traffic</span>
                            <span>üì°</span>
                        </div>
                        <div class="stats-row">
                            <div class="stat">
                                <div class="stat-value">${status.traffic_5m}</div>
                                <div class="stat-label">Last 5 min</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${status.traffic_15m}</div>
                                <div class="stat-label">Last 15 min</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${pins.length}</div>
                                <div class="stat-label">Close Contacts</div>
                            </div>
                        </div>
                    </div>

                    <!-- Manufacturer Summary -->
                    <div class="card" style="grid-column: span 2;">
                        <div class="card-header">
                            <span class="card-title">Manufacturers Detected</span>
                            <span>ÔøΩicing</span>
                        </div>
                        <div class="vendor-summary">
                            ${getVendorSummary(pins)}
                        </div>
                    </div>

                    <!-- Close Contacts List -->
                    <div class="card" style="grid-column: span 2;">
                        <div class="card-header">
                            <span class="card-title">Close Contacts (Signal > -50dBm)</span>
                            <span>üì∂</span>
                        </div>
                        <div class="device-list">
                            ${renderDeviceList(pins, status.drone_list || [], targets.stalker_macs || [], watchlist)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDeviceList(pins, drones, stalkers, watchlist = {}) {
            if (!pins.length && !drones.length) {
                return '<div style="color: #666; text-align: center; padding: 20px;">No close contacts detected</div>';
            }

            const stalkerSet = new Set(stalkers.map(m => m.toUpperCase()));
            const droneSet = new Set(drones.map(m => m.toUpperCase()));
            const watchedSet = new Set((watchlist.watched_macs || []).map(m => m.toUpperCase()));
            const attackerSet = new Set((watchlist.attacker_macs || []).map(m => m.toUpperCase()));

            // Combine and deduplicate
            const devices = new Map();

            drones.forEach(mac => {
                devices.set(mac.toUpperCase(), { id: mac, type: 'DRONE' });
            });

            pins.forEach(pin => {
                const macUpper = pin.id.toUpperCase();
                if (!devices.has(macUpper)) {
                    devices.set(macUpper, pin);
                }
            });

            return Array.from(devices.values())
                .slice(0, 100)
                .map(device => {
                    const { vendor, category, isRandomized } = lookupVendor(device.id);
                    const macUpper = device.id.toUpperCase();
                    const isWatched = watchedSet.has(macUpper);
                    const isAttacker = attackerSet.has(macUpper);
                    const isStalker = stalkerSet.has(macUpper) && !isWatched && !isAttacker;
                    const isDrone = droneSet.has(macUpper) || device.type === 'DRONE';

                    let typeClass = 'type-close';
                    let typeLabel = 'CLOSE';

                    // Priority: Attacker > Drone > Watched > Stalker > Close
                    if (isAttacker) {
                        typeClass = 'type-attacker';
                        typeLabel = 'THREAT';
                    } else if (isDrone) {
                        typeClass = 'type-drone';
                        typeLabel = 'DRONE';
                    } else if (isWatched) {
                        typeClass = 'type-watched';
                        typeLabel = 'WATCHED';
                    } else if (isStalker) {
                        typeClass = 'type-stalker';
                        typeLabel = 'STALKER';
                    }

                    return `
                        <div class="device-item">
                            <div class="device-info">
                                <span class="device-mac">${device.id}</span>
                                <span class="device-vendor ${isRandomized ? 'randomized' : ''}">${vendor}</span>
                            </div>
                            <span class="device-category ${getCategoryClass(category)}">${getCategoryLabel(category)}</span>
                            <span class="device-type ${typeClass}">${typeLabel}</span>
                        </div>
                    `;
                }).join('');
        }

        function renderError(error) {
            const content = document.getElementById('dashboard-content');
            const connectionStatus = document.getElementById('connection-status');

            connectionStatus.textContent = 'Offline';
            connectionStatus.className = 'status-badge status-offline';

            content.innerHTML = `
                <div class="error">
                    <h3>Connection Error</h3>
                    <p>${error.message}</p>
                    <p style="margin-top: 10px; font-size: 12px;">Retrying in ${REFRESH_INTERVAL / 1000} seconds...</p>
                </div>
            `;
        }

        async function updateDashboard() {
            try {
                const [status, targets, watchlist, attacks] = await Promise.all([
                    fetchStatus(),
                    fetchTargets(),
                    fetchWatchlist(),
                    fetchAttacks()
                ]);
                renderDashboard(status, targets, watchlist, attacks);
            } catch (error) {
                renderError(error);
            }
        }

        // Initial load
        updateDashboard();

        // Auto-refresh
        setInterval(updateDashboard, REFRESH_INTERVAL);
    </script>
</body>
</html>
