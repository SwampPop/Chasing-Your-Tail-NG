<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYT Dashboard - AO Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            min-height: 100vh;
        }

        .main-content {
            padding: 20px;
            overflow-y: auto;
        }

        /* AO Side Panel */
        .ao-panel {
            background: rgba(0, 0, 0, 0.4);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ao-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ao-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
        }

        .ao-stat {
            text-align: center;
        }

        .ao-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }

        .ao-stat-label {
            color: #666;
            font-size: 10px;
            text-transform: uppercase;
        }

        .ao-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            overflow: hidden;
        }

        .ao-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .ao-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ao-section-count {
            font-size: 11px;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .ao-section-content {
            max-height: 200px;
            overflow-y: auto;
        }

        .ao-device {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 12px;
        }

        .ao-device:last-child {
            border-bottom: none;
        }

        .ao-device-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .icon-arrival {
            background: rgba(34, 197, 94, 0.2);
        }

        .icon-departure {
            background: rgba(239, 68, 68, 0.2);
        }

        .icon-regular {
            background: rgba(99, 102, 241, 0.2);
        }

        .icon-new {
            background: rgba(234, 179, 8, 0.2);
        }

        .ao-device-info {
            flex: 1;
            min-width: 0;
        }

        .ao-device-mac {
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ao-device-vendor {
            font-size: 10px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ao-device-meta {
            text-align: right;
            font-size: 10px;
            color: #888;
        }

        .ao-device-time {
            color: #22c55e;
        }

        .ao-device-signal {
            color: #3b82f6;
        }

        .pattern-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .pattern-constant {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .pattern-frequent {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .pattern-occasional {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .pattern-rare {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: #555;
            font-size: 12px;
        }

        /* Device naming modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 16px;
            color: #fff;
            font-size: 18px;
        }

        .modal-mac {
            font-family: 'SF Mono', Monaco, monospace;
            background: rgba(255,255,255,0.05);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .modal-info {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 12px;
        }

        .modal-info-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .modal-info-row:last-child {
            border-bottom: none;
        }

        .modal-tips {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 11px;
        }

        .modal-tips ul {
            margin: 8px 0 0 16px;
            color: #a5b4fc;
        }

        .modal-tips li {
            margin-bottom: 4px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            color: #888;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #6366f1;
            color: #fff;
        }

        .btn-primary:hover {
            background: #5855e0;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-danger {
            background: rgba(239,68,68,0.2);
            color: #ef4444;
        }

        .btn-danger:hover {
            background: rgba(239,68,68,0.3);
        }

        /* Clickable device items */
        .device-item.clickable, .ao-device.clickable {
            cursor: pointer;
            transition: background 0.2s;
        }

        .device-item.clickable:hover, .ao-device.clickable:hover {
            background: rgba(255,255,255,0.05);
        }

        /* Device alias display */
        .device-alias {
            color: #22c55e;
            font-weight: 600;
            font-size: 12px;
        }

        /* Owner category badges */
        .owner-mine { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .owner-household { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .owner-neighbor { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .owner-guest { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .owner-infrastructure { background: rgba(107, 114, 128, 0.2); color: #6b7280; }
        .owner-suspicious { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        /* Main Dashboard Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .kismet-link {
            padding: 6px 12px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid #6366f1;
            border-radius: 8px;
            color: #a5b4fc;
            text-decoration: none;
            font-size: 12px;
            transition: all 0.2s;
        }

        .kismet-link:hover {
            background: rgba(99, 102, 241, 0.3);
            color: #fff;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-online {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .status-offline {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 42px;
            font-weight: 700;
            color: #fff;
            line-height: 1;
        }

        .card-subtitle {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .alert-card {
            grid-column: span 2;
        }

        .alert-level {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .alert-indicator {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            animation: pulse 2s infinite;
        }

        .alert-GREEN {
            background: radial-gradient(circle, rgba(34, 197, 94, 0.3) 0%, rgba(34, 197, 94, 0.1) 70%);
            box-shadow: 0 0 40px rgba(34, 197, 94, 0.3);
        }

        .alert-YELLOW {
            background: radial-gradient(circle, rgba(234, 179, 8, 0.3) 0%, rgba(234, 179, 8, 0.1) 70%);
            box-shadow: 0 0 40px rgba(234, 179, 8, 0.3);
        }

        .alert-RED {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.3) 0%, rgba(239, 68, 68, 0.1) 70%);
            box-shadow: 0 0 40px rgba(239, 68, 68, 0.3);
            animation: pulse-red 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.9; }
        }

        @keyframes pulse-red {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .alert-details {
            flex: 1;
        }

        .alert-details h2 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .alert-details p {
            color: #888;
            font-size: 14px;
        }

        .text-green { color: #22c55e; }
        .text-yellow { color: #eab308; }
        .text-red { color: #ef4444; }

        .stats-row {
            display: flex;
            gap: 24px;
            margin-top: 12px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .device-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .device-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .device-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .device-mac {
            color: #fff;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 11px;
        }

        .device-vendor {
            color: #888;
            font-size: 10px;
        }

        .device-vendor.randomized {
            color: #a855f7;
            font-style: italic;
        }

        .device-category {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 9px;
            text-transform: uppercase;
        }

        .cat-network { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .cat-mobile { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .cat-iot { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .cat-media { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .cat-unknown { background: rgba(107, 114, 128, 0.2); color: #6b7280; }

        .device-type {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
        }

        .type-drone { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .type-close { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .type-stalker { background: rgba(239, 68, 68, 0.3); color: #ef4444; font-weight: 600; }

        footer {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #333;
            color: #555;
            font-size: 12px;
        }

        .last-update {
            margin-top: 8px;
            font-size: 11px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 1200px) {
            .layout {
                grid-template-columns: 1fr;
            }
            .ao-panel {
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
        }

        @media (max-width: 768px) {
            .alert-card { grid-column: span 1; }
            .alert-level { flex-direction: column; text-align: center; }
            .card-value { font-size: 32px; }
        }
    </style>
</head>
<body>
    <div class="layout">
        <div class="main-content">
            <header>
                <div class="header-left">
                    <h1>CYT Dashboard</h1>
                    <a href="http://10.211.55.10:2501" target="_blank" class="kismet-link">Kismet UI</a>
                </div>
                <span id="connection-status" class="status-badge status-offline">Connecting...</span>
            </header>

            <div id="dashboard-content">
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Connecting to CYT API...</span>
                </div>
            </div>

            <footer>
                <div>Chasing Your Tail NG v2.3 - Wireless Surveillance Detection</div>
                <div class="last-update">Last updated: <span id="last-update">--</span></div>
            </footer>
        </div>

        <div class="ao-panel">
            <div class="ao-header">
                <h2>AO Tracker</h2>
                <div class="ao-stats">
                    <div class="ao-stat">
                        <div class="ao-stat-value" id="ao-tracked">-</div>
                        <div class="ao-stat-label">Tracked</div>
                    </div>
                    <div class="ao-stat">
                        <div class="ao-stat-value" id="ao-arrivals-hr">-</div>
                        <div class="ao-stat-label">Arrivals/hr</div>
                    </div>
                    <div class="ao-stat">
                        <div class="ao-stat-value" id="ao-departures-hr">-</div>
                        <div class="ao-stat-label">Departures/hr</div>
                    </div>
                </div>
            </div>

            <!-- Recent Arrivals -->
            <div class="ao-section">
                <div class="ao-section-header">
                    <span class="ao-section-title" style="color: #22c55e;">Recent Arrivals</span>
                    <span class="ao-section-count" id="arrivals-count">0</span>
                </div>
                <div class="ao-section-content" id="arrivals-list">
                    <div class="empty-state">Monitoring for arrivals...</div>
                </div>
            </div>

            <!-- Recent Departures -->
            <div class="ao-section">
                <div class="ao-section-header">
                    <span class="ao-section-title" style="color: #ef4444;">Recent Departures</span>
                    <span class="ao-section-count" id="departures-count">0</span>
                </div>
                <div class="ao-section-content" id="departures-list">
                    <div class="empty-state">Monitoring for departures...</div>
                </div>
            </div>

            <!-- New/Unknown Devices -->
            <div class="ao-section">
                <div class="ao-section-header">
                    <span class="ao-section-title" style="color: #eab308;">New Devices</span>
                    <span class="ao-section-count" id="new-count">0</span>
                </div>
                <div class="ao-section-content" id="new-list">
                    <div class="empty-state">No new devices</div>
                </div>
            </div>

            <!-- AO Regulars -->
            <div class="ao-section">
                <div class="ao-section-header">
                    <span class="ao-section-title" style="color: #6366f1;">AO Regulars</span>
                    <span class="ao-section-count" id="regulars-count">0</span>
                </div>
                <div class="ao-section-content" id="regulars-list">
                    <div class="empty-state">Building device patterns...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Naming Modal -->
    <div class="modal-overlay" id="device-modal">
        <div class="modal">
            <h3>Device Details</h3>
            <div class="modal-mac" id="modal-mac">--:--:--:--:--:--</div>

            <div class="modal-info" id="modal-device-info">
                <div class="modal-info-row">
                    <span>Vendor:</span>
                    <span id="modal-vendor">Loading...</span>
                </div>
                <div class="modal-info-row">
                    <span>Signal:</span>
                    <span id="modal-signal">--</span>
                </div>
                <div class="modal-info-row">
                    <span>First Seen:</span>
                    <span id="modal-first-seen">--</span>
                </div>
                <div class="modal-info-row">
                    <span>Last Seen:</span>
                    <span id="modal-last-seen">--</span>
                </div>
                <div class="modal-info-row">
                    <span>Appearances:</span>
                    <span id="modal-appearances">--</span>
                </div>
                <div class="modal-info-row">
                    <span>Connected To:</span>
                    <span id="modal-connected-to">--</span>
                </div>
            </div>

            <div class="modal-tips" id="modal-tips">
                <strong>Identification Tips:</strong>
                <ul id="modal-tips-list"></ul>
            </div>

            <form id="alias-form">
                <div class="form-group">
                    <label>Device Name</label>
                    <input type="text" id="alias-name" placeholder="e.g., John's iPhone, Living Room Roku">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="alias-category">
                        <option value="unknown">Unknown</option>
                        <option value="mine">Mine</option>
                        <option value="household">Household</option>
                        <option value="neighbor">Neighbor</option>
                        <option value="guest">Guest</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="suspicious">Suspicious</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <input type="text" id="alias-notes" placeholder="e.g., North neighbor, Work colleague">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-danger" id="btn-delete-alias" style="display:none;">Delete</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const REFRESH_INTERVAL = 10000;
        let deviceAliases = {};  // MAC -> {name, category, notes}
        let currentModalMac = null;

        // SECURITY: HTML escape function to prevent XSS attacks
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load aliases from server
        async function loadAliases() {
            try {
                const response = await fetch('/api/aliases');
                const data = await response.json();
                deviceAliases = data.aliases || {};
            } catch (error) {
                console.error('Failed to load aliases:', error);
            }
        }

        // Get alias for a MAC address
        function getAlias(mac) {
            return deviceAliases[mac.toUpperCase()] || null;
        }

        // Open device modal
        async function openDeviceModal(mac) {
            currentModalMac = mac.toUpperCase();
            const modal = document.getElementById('device-modal');
            modal.classList.add('active');

            // Set MAC
            document.getElementById('modal-mac').textContent = currentModalMac;

            // Reset form
            document.getElementById('alias-name').value = '';
            document.getElementById('alias-category').value = 'unknown';
            document.getElementById('alias-notes').value = '';
            document.getElementById('btn-delete-alias').style.display = 'none';

            // Load existing alias if any
            const alias = getAlias(currentModalMac);
            if (alias) {
                document.getElementById('alias-name').value = alias.name || '';
                document.getElementById('alias-category').value = alias.category || 'unknown';
                document.getElementById('alias-notes').value = alias.notes || '';
                document.getElementById('btn-delete-alias').style.display = 'block';
            }

            // Fetch device details from server
            try {
                const response = await fetch(`/api/device/${encodeURIComponent(currentModalMac)}/identify`);
                const data = await response.json();

                document.getElementById('modal-vendor').textContent = data.vendor || 'Unknown';

                if (data.device_info) {
                    document.getElementById('modal-signal').textContent = data.device_info.signal ? `${data.device_info.signal} dBm` : '--';
                    document.getElementById('modal-first-seen').textContent = data.device_info.first_seen || '--';
                    document.getElementById('modal-last-seen').textContent = data.device_info.last_seen || '--';
                    document.getElementById('modal-connected-to').textContent = data.device_info.connected_to || 'Not associated';
                }

                if (data.history) {
                    document.getElementById('modal-appearances').textContent = data.history.total_appearances || '0';
                }

                // Show tips (SECURITY: escape HTML to prevent XSS)
                const tipsList = document.getElementById('modal-tips-list');
                tipsList.innerHTML = (data.identification_tips || [])
                    .map(tip => `<li>${escapeHtml(tip)}</li>`)
                    .join('');

            } catch (error) {
                console.error('Failed to load device details:', error);
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('device-modal').classList.remove('active');
            currentModalMac = null;
        }

        // Save alias
        document.getElementById('alias-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentModalMac) return;

            const name = document.getElementById('alias-name').value.trim();
            const category = document.getElementById('alias-category').value;
            const notes = document.getElementById('alias-notes').value.trim();

            if (!name) {
                alert('Please enter a device name');
                return;
            }

            try {
                const response = await fetch('/api/aliases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mac: currentModalMac, name, category, notes })
                });

                if (response.ok) {
                    await loadAliases();
                    closeModal();
                    updateDashboard();  // Refresh to show new alias
                }
            } catch (error) {
                console.error('Failed to save alias:', error);
                alert('Failed to save alias');
            }
        });

        // Delete alias
        document.getElementById('btn-delete-alias').addEventListener('click', async () => {
            if (!currentModalMac) return;
            if (!confirm('Delete this device alias?')) return;

            try {
                const response = await fetch(`/api/aliases/${encodeURIComponent(currentModalMac)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadAliases();
                    closeModal();
                    updateDashboard();
                }
            } catch (error) {
                console.error('Failed to delete alias:', error);
            }
        });

        // Close modal when clicking overlay
        document.getElementById('device-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        const OUI_DATABASE = {
            '000A27': 'Apple', '000A95': 'Apple', '000D93': 'Apple', '001451': 'Apple',
            '0016CB': 'Apple', '0017F2': 'Apple', '0019E3': 'Apple', '001B63': 'Apple',
            '9C3E53': 'Apple', 'A4D1D2': 'Apple', 'ACBC32': 'Apple', 'B8E856': 'Apple',
            '002119': 'Samsung', '002339': 'Samsung', '002566': 'Samsung', '1C62B8': 'Samsung',
            '1C7B21': 'Google', '3C5AB4': 'Google', '54609A': 'Google', '94EB2C': 'Google',
            '00FC8B': 'Amazon', '0C47C9': 'Amazon', '38F73D': 'Amazon', '1CFE2B': 'Amazon',
            'D016C7': 'eero', 'B42046': 'eero',
            '001A2B': 'Cisco', '001B2F': 'Netgear', '001E58': 'D-Link', '18A5FF': 'Arcadyan',
            'B09575': 'TP-Link', 'C04A00': 'TP-Link', 'E894F6': 'TP-Link',
            '105932': 'Roku', 'B0A737': 'Roku', '5CAAFD': 'Sonos', '48A6B8': 'Sonos',
            'ACD074': 'Espressif', '240AC4': 'Espressif', 'A0A3B3': 'Espressif',
            'C44FD5': 'Vantiva', '6C55E8': 'Vantiva', '8C2DAA': 'Vantiva',
            '48E2AD': 'HUMAX', 'A840F8': 'HUMAX',
            '606001F': 'DJI', '34D262': 'DJI', '60601F': 'DJI',
            '786DEB': 'GE Lighting', '2CC1F4': 'Nokia'
        };

        const VENDOR_CATEGORIES = {
            'Apple': 'mobile', 'Samsung': 'mobile', 'Google': 'iot', 'Amazon': 'iot',
            'eero': 'network', 'Cisco': 'network', 'Netgear': 'network', 'D-Link': 'network',
            'TP-Link': 'network', 'Arcadyan': 'network', 'Vantiva': 'network', 'HUMAX': 'network',
            'Roku': 'media', 'Sonos': 'media', 'Espressif': 'iot', 'Nokia': 'network',
            'GE Lighting': 'iot', 'DJI': 'drone'
        };

        function isRandomizedMac(mac) {
            const firstByte = parseInt(mac.replace(/:/g, '').substring(0, 2), 16);
            return (firstByte & 0x02) !== 0;
        }

        function lookupVendor(mac) {
            if (isRandomizedMac(mac)) {
                return { vendor: 'Randomized', category: 'unknown', isRandomized: true };
            }
            const oui = mac.replace(/:/g, '').substring(0, 6).toUpperCase();
            const vendor = OUI_DATABASE[oui] || 'Unknown';
            const category = VENDOR_CATEGORIES[vendor] || 'unknown';
            return { vendor, category, isRandomized: false };
        }

        function getCategoryClass(category) {
            return {
                'network': 'cat-network', 'mobile': 'cat-mobile', 'iot': 'cat-iot',
                'media': 'cat-media', 'drone': 'type-drone', 'unknown': 'cat-unknown'
            }[category] || 'cat-unknown';
        }

        function getCategoryLabel(category) {
            return {
                'network': 'Net', 'mobile': 'Mobile', 'iot': 'IoT',
                'media': 'Media', 'drone': 'Drone', 'unknown': '?'
            }[category] || '?';
        }

        function getAlertIcon(level) {
            return { 'GREEN': '✓', 'YELLOW': '⚠', 'RED': '⚠' }[level] || '?';
        }

        function getAlertMessage(level, drones, traffic) {
            if (level === 'RED') return `ALERT: ${drones} drone(s) detected!`;
            if (level === 'YELLOW') return `Elevated activity: ${traffic} devices`;
            return 'All clear. No threats detected.';
        }

        async function fetchData(endpoint) {
            try {
                const response = await fetch(`/api/${endpoint}`);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Failed to fetch ${endpoint}:`, error);
                throw error;
            }
        }

        function renderMainDashboard(status, targets) {
            const content = document.getElementById('dashboard-content');
            const connectionStatus = document.getElementById('connection-status');
            const lastUpdate = document.getElementById('last-update');

            connectionStatus.textContent = 'Online';
            connectionStatus.className = 'status-badge status-online';
            lastUpdate.textContent = new Date().toLocaleTimeString();

            const alertLevel = status.alert_level || 'GREEN';
            const pins = status.map_pins || [];

            content.innerHTML = `
                <div class="grid">
                    <div class="card alert-card">
                        <div class="card-header">
                            <span class="card-title">Threat Level</span>
                        </div>
                        <div class="alert-level">
                            <div class="alert-indicator alert-${alertLevel}">
                                ${getAlertIcon(alertLevel)}
                            </div>
                            <div class="alert-details">
                                <h2 class="text-${alertLevel.toLowerCase()}">${alertLevel}</h2>
                                <p>${getAlertMessage(alertLevel, status.drones_detected, status.traffic_5m)}</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Drones</span>
                        </div>
                        <div class="card-value ${status.drones_detected > 0 ? 'text-red' : ''}">${status.drones_detected}</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Stalkers</span>
                        </div>
                        <div class="card-value ${targets.stalker_count > 0 ? 'text-yellow' : ''}">${targets.stalker_count}</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Traffic</span>
                        </div>
                        <div class="stats-row">
                            <div class="stat">
                                <div class="stat-value">${status.traffic_5m}</div>
                                <div class="stat-label">5 min</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${status.traffic_15m}</div>
                                <div class="stat-label">15 min</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${pins.length}</div>
                                <div class="stat-label">Close</div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="grid-column: span 2;">
                        <div class="card-header">
                            <span class="card-title">Close Contacts</span>
                        </div>
                        <div class="device-list">
                            ${renderDeviceList(pins, status.drone_list || [], targets.stalker_macs || [])}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDeviceList(pins, drones, stalkers) {
            if (!pins.length) return '<div style="color:#666;text-align:center;padding:20px;">No close contacts</div>';

            const stalkerSet = new Set(stalkers.map(m => m.toUpperCase()));
            const droneSet = new Set(drones.map(m => m.toUpperCase()));

            return pins.slice(0, 50).map(device => {
                const { vendor, category, isRandomized } = lookupVendor(device.id);
                const macUpper = device.id.toUpperCase();
                const isStalker = stalkerSet.has(macUpper);
                const isDrone = droneSet.has(macUpper);
                const alias = getAlias(macUpper);

                let typeClass = 'type-close', typeLabel = 'CLOSE';
                if (isDrone) { typeClass = 'type-drone'; typeLabel = 'DRONE'; }
                else if (isStalker) { typeClass = 'type-stalker'; typeLabel = 'STALKER'; }

                // Show alias name if available, otherwise show MAC (SECURITY: escape HTML)
                const displayName = alias ? `<span class="device-alias">${escapeHtml(alias.name)}</span>` : '';
                const ownerBadge = alias ? `<span class="pattern-badge owner-${escapeHtml(alias.category)}">${escapeHtml(alias.category)}</span>` : '';

                return `
                    <div class="device-item clickable" onclick="openDeviceModal('${device.id}')">
                        <div class="device-info">
                            ${displayName}
                            <span class="device-mac">${device.id}</span>
                            <span class="device-vendor ${isRandomized ? 'randomized' : ''}">${vendor} (${device.signal} dBm)</span>
                        </div>
                        ${ownerBadge}
                        <span class="device-category ${getCategoryClass(category)}">${getCategoryLabel(category)}</span>
                        <span class="device-type ${typeClass}">${typeLabel}</span>
                    </div>
                `;
            }).join('');
        }

        function renderAOPanel(activity, regulars, summary) {
            // Update stats
            document.getElementById('ao-tracked').textContent = summary.total_tracked || 0;
            document.getElementById('ao-arrivals-hr').textContent = summary.arrivals_last_hour || 0;
            document.getElementById('ao-departures-hr').textContent = summary.departures_last_hour || 0;

            // Helper to render AO device with alias support (SECURITY: uses escapeHtml)
            function renderAODevice(d, iconClass, icon, showTime = false, showSignal = false, showPattern = false) {
                const macUpper = d.mac.toUpperCase();
                const alias = getAlias(macUpper);
                const aliasDisplay = alias ? `<div class="device-alias" style="font-size:11px;">${escapeHtml(alias.name)}</div>` : '';
                const ownerBadge = alias ? `<span class="pattern-badge owner-${escapeHtml(alias.category)}" style="font-size:8px;">${escapeHtml(alias.category)}</span>` : '';

                return `
                    <div class="ao-device clickable" onclick="openDeviceModal('${d.mac}')">
                        <div class="ao-device-icon ${iconClass}">${icon}</div>
                        <div class="ao-device-info">
                            ${aliasDisplay}
                            <div class="ao-device-mac">${d.mac}</div>
                            <div class="ao-device-vendor">${d.vendor || lookupVendor(d.mac).vendor}</div>
                        </div>
                        <div class="ao-device-meta">
                            ${ownerBadge}
                            ${showTime ? `<div class="ao-device-time">${d.time_str}</div>` : ''}
                            ${showSignal && d.signal ? `<div class="ao-device-signal">${d.signal} dBm</div>` : ''}
                            ${showPattern ? `<span class="pattern-badge pattern-${d.pattern}">${d.pattern}</span><div style="font-size:9px;margin-top:2px;">${d.appearances} times</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Arrivals
            const arrivalsCount = activity.recent_arrivals?.length || 0;
            document.getElementById('arrivals-count').textContent = arrivalsCount;
            document.getElementById('arrivals-list').innerHTML = arrivalsCount > 0
                ? activity.recent_arrivals.slice(0, 10).map(d => renderAODevice(d, 'icon-arrival', '+', true, true)).join('')
                : '<div class="empty-state">No recent arrivals</div>';

            // Departures
            const departuresCount = activity.recent_departures?.length || 0;
            document.getElementById('departures-count').textContent = departuresCount;
            document.getElementById('departures-list').innerHTML = departuresCount > 0
                ? activity.recent_departures.slice(0, 10).map(d => renderAODevice(d, 'icon-departure', '-', true, false)).join('')
                : '<div class="empty-state">No recent departures</div>';

            // New Devices
            const newCount = summary.new_devices?.length || 0;
            document.getElementById('new-count').textContent = newCount;
            document.getElementById('new-list').innerHTML = newCount > 0
                ? summary.new_devices.slice(0, 10).map(d => renderAODevice(d, 'icon-new', '?', false, true)).join('')
                : '<div class="empty-state">No new devices</div>';

            // Regulars
            const regularsCount = regulars.regulars?.length || 0;
            document.getElementById('regulars-count').textContent = regularsCount;
            document.getElementById('regulars-list').innerHTML = regularsCount > 0
                ? regulars.regulars.slice(0, 15).map(d => renderAODevice(d, 'icon-regular', '★', false, false, true)).join('')
                : '<div class="empty-state">Building patterns...</div>';
        }

        function renderError(error) {
            const content = document.getElementById('dashboard-content');
            const connectionStatus = document.getElementById('connection-status');

            connectionStatus.textContent = 'Offline';
            connectionStatus.className = 'status-badge status-offline';

            content.innerHTML = `
                <div class="error">
                    <h3>Connection Error</h3>
                    <p>${error.message}</p>
                    <p style="margin-top:10px;font-size:12px;">Retrying in ${REFRESH_INTERVAL/1000}s...</p>
                </div>
            `;
        }

        async function updateDashboard() {
            try {
                const [status, targets, activity, regulars, summary] = await Promise.all([
                    fetchData('status'),
                    fetchData('targets').catch(() => ({ stalker_count: 0, stalker_macs: [] })),
                    fetchData('ao/activity'),
                    fetchData('ao/regulars'),
                    fetchData('ao/summary')
                ]);

                renderMainDashboard(status, targets);
                renderAOPanel(activity, regulars, summary);
            } catch (error) {
                renderError(error);
            }
        }

        // Initial load - load aliases first, then start dashboard
        async function init() {
            await loadAliases();
            await updateDashboard();
            setInterval(updateDashboard, REFRESH_INTERVAL);
        }
        init();
    </script>
</body>
</html>
